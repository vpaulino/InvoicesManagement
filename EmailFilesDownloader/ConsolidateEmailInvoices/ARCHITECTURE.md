# Architecture Overview

## ??? Layered Architecture Diagram

```
???????????????????????????????????????????????????????????????????
?                         Program.cs                               ?
?                    (Entry Point + DI Setup)                      ?
???????????????????????????????????????????????????????????????????
                             ?
                             ? Orchestrates
                             ?
???????????????????????????????????????????????????????????????????
?                    Services Layer                                ?
???????????????????????????????????????????????????????????????????
?  IEmailProcessor ??????????? EmailProcessor                     ?
?  IGmailService ????????????? GmailServiceWrapper                ?
??????????????????????????????????????????????????????????????????
      ?                  ?                 ?
      ? Uses             ? Uses            ? Uses
      ?                  ?                 ?
???????????????   ????????????????   ????????????????
?Configuration?   ?Authentication?   ? Attachments  ?
?   Layer     ?   ?    Layer     ?   ?    Layer     ?
???????????????   ????????????????   ????????????????
?IConfig      ?   ?IGoogleAuth   ?   ?IAttachment   ?
?Service      ?   ?enticator     ?   ?Filter        ?
?             ?   ?              ?   ?              ?
?AppSettings  ?   ?UserCredential?   ?IAttachment   ?
?             ?   ?              ?   ?Downloader    ?
???????????????   ????????????????   ????????????????
                                              ?
                                              ? Saves to
                                              ?
                                     ????????????????
                                     ?  FileSystem  ?
                                     ?    Layer     ?
                                     ????????????????
                                     ?IFileStorage  ?
                                     ?Service       ?
                                     ????????????????
```

## ?? Data Flow Diagram

```
1. Start Application
        ?
        ?
2. Load Configuration (ConfigurationService)
        ?
        ??? Validate Settings
        ??? Load Email Mappings
        ?
        ?
3. Authenticate (GoogleAuthenticator)
        ?
        ??? Read credentials.json
        ??? OAuth 2.0 Flow
        ??? Store token.json
        ?
        ?
4. Create Gmail Service (GmailServiceWrapper)
        ?
        ??? Initialize with credentials
        ?
        ?
5. FOR EACH Email Mapping:
        ?
        ??? EmailProcessor.ProcessEmailsFromSenderAsync()
        ?   ?
        ?   ??? Query Gmail API (GmailService)
        ?   ?   ??? Get unread emails from sender
        ?   ?
        ?   ??? FOR EACH Email:
        ?   ?   ?
        ?   ?   ??? Get message details
        ?   ?   ?
        ?   ?   ??? Filter attachments (AttachmentFilter)
        ?   ?   ?   ??? Check MIME types
        ?   ?   ?
        ?   ?   ??? FOR EACH Valid Attachment:
        ?   ?   ?   ?
        ?   ?   ?   ??? Download (AttachmentDownloader)
        ?   ?   ?   ?   ??? Get attachment data
        ?   ?   ?   ?   ??? Decode base64url
        ?   ?   ?   ?
        ?   ?   ?   ??? Save to disk (FileStorageService)
        ?   ?   ?       ??? Create directory
        ?   ?   ?       ??? Write file
        ?   ?   ?
        ?   ?   ??? Mark as read (GmailService)
        ?   ?
        ?   ??? Return ProcessingResult
        ?
        ??? Log results
        ?
        ?
6. Application Complete
```

## ?? Component Dependency Graph

```
Program.cs
    ?
    ??? IConfigurationService
    ?   ??? IConfiguration (Microsoft)
    ?
    ??? IGoogleAuthenticator
    ?   ??? Google.Apis.Auth.OAuth2
    ?
    ??? GmailService (Google)
    ?   ??? UserCredential
    ?
    ??? IGmailService
    ?   ??? GmailService (Google)
    ?
    ??? IEmailProcessor
    ?   ??? IGmailService
    ?   ??? IAttachmentFilter
    ?   ??? IAttachmentDownloader
    ?   ?   ??? IGmailService
    ?   ??? IFileStorageService
    ?   ??? ILogger
    ?
    ??? ILogger (Microsoft)
```

## ?? Class Responsibility Matrix

| Layer | Class | Responsibilities | Dependencies |
|-------|-------|------------------|--------------|
| **Entry** | `Program.cs` | • DI container setup<br>• Service registration<br>• Application orchestration | All services |
| **Configuration** | `ConfigurationService` | • Load app.json<br>• Bind settings<br>• Validate configuration | `IConfiguration` |
| | `AppSettings` | • Hold application settings | None (POCO) |
| **Authentication** | `GoogleAuthenticator` | • OAuth 2.0 flow<br>• Token management<br>• Credential storage | Google.Apis.Auth |
| **Services** | `EmailProcessor` | • Orchestrate workflow<br>• Error handling<br>• Result tracking | `IGmailService`<br>`IAttachmentFilter`<br>`IAttachmentDownloader`<br>`IFileStorageService`<br>`ILogger` |
| | `GmailServiceWrapper` | • Wrap Gmail API<br>• Query emails<br>• Get attachments<br>• Modify labels | `GmailService` (Google) |
| **Attachments** | `AttachmentFilter` | • Validate MIME types<br>• Filter valid attachments | None |
| | `AttachmentDownloader` | • Download attachments<br>• Decode base64url | `IGmailService` |
| **FileSystem** | `FileStorageService` | • Create directories<br>• Write files<br>• Path management | None (System.IO) |
| **Models** | `EmailQuery` | • Search criteria<br>• Query string builder | None (POCO) |
| | `EmailAttachment` | • Attachment data holder | None (POCO) |
| | `ProcessingResult` | • Result tracking | None (POCO) |
| **Extensions** | `Base64UrlExtensions` | • RFC 4648 decoder | None |

## ?? Dependency Injection Container

```
ServiceCollection
??? Singleton: IConfigurationService ? ConfigurationService
??? Singleton: IGoogleAuthenticator ? GoogleAuthenticator
??? Singleton: GmailService ? (Factory)
??? Singleton: IGmailService ? GmailServiceWrapper
??? Singleton: IAttachmentFilter ? AttachmentFilter
??? Singleton: IAttachmentDownloader ? AttachmentDownloader
??? Singleton: IFileStorageService ? FileStorageService
??? Singleton: IEmailProcessor ? EmailProcessor
??? Logging: ILogger<T> ? ConsoleLogger
```

## ?? Interface Segregation

Each interface represents a specific contract:

- `IConfigurationService` - Configuration operations
- `IGoogleAuthenticator` - Authentication operations
- `IGmailService` - Gmail API operations
- `IEmailProcessor` - Email processing orchestration
- `IAttachmentFilter` - Attachment validation
- `IAttachmentDownloader` - Attachment retrieval
- `IFileStorageService` - File system operations

This allows for:
- Easy mocking in tests
- Swapping implementations
- Clear contracts between layers

## ?? Package Dependencies

```
ExtractLoadInvoices.csproj
??? Google.Apis.Gmail.v1 (1.55.0.2510)
?   ??? Google.Apis.Auth.OAuth2
??? Microsoft.Extensions.Hosting (8.0.0)
?   ??? Microsoft.Extensions.DependencyInjection
?   ??? Microsoft.Extensions.Configuration
?   ??? Microsoft.Extensions.Logging
??? Microsoft.Extensions.Logging.Console (8.0.0)
??? Microsoft.Extensions.Configuration.Json (8.0.0)
```
